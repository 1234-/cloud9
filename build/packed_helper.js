var fs = require('fs');

var extensions = require("../configs/default.js").containers.master.plugins;
var clientPlugins = [ ];

//console.log(extensions);

for (var i in extensions) {
    if (extensions[i].packagePath && extensions[i].packagePath.indexOf("cloud9.core") >= 0) {
        //console.log(extensions[i].clientPlugins);
        for (var p in extensions[i].clientPlugins) {
        	var name = extensions[i].clientPlugins[p].split("/");
        	var ext = "plugins-client/ext." + name[1] + "/" + name[1];
        	clientPlugins.push(ext);
        }
        clientPlugins = "'" + clientPlugins.join("',\n\t'") + "'";
        break;
    }
}

var appFile = '// THIS FILE IS AUTOMATICALLY GENERATED BY: packed_helper.js\n\n' +
    ' ({\n' +
        'optimize: "none",\n' +
        'baseUrl: "../",\n'+
        'paths: {\n' +
         '"core" : "empty:",\n' +
         '"ext" : "empty:",\n' +
         '"apf" : "empty:",\n' +
         '"treehugger" : "empty:"\n' +
        '},\n' +
        ' include: ["build/src/core.packed", ' + clientPlugins + '], \n' +  
        'out: "../plugins-client/ext.packed/packed.js",\n' +
        'inlineText: true,\n'+ 
        'findNestedDependencies: true,\n'+
        'optimizeAllPluginResources: false,\n' +
        'useStrict: true,\n' +
        'wrap: true,\n' +
        'onBuildRead: function (moduleName, path, contents) {\n' +
                'var textRegExp = new RegExp(/text!ext\\/(\\w+)\\//g);\n' +
                'var match;\n' +
                'if ( (match = contents.match(textRegExp) ) ) {\n' +
                '        for (var m in match) {\n' +
                '                var name = match[m].split("/")[1];\n' +
                '                var path = "text!plugins-client/ext." + name + "/";\n' +
                '                contents = contents.replace(match[m], path);\n' +
                '        }\n' +
                '}\n\n' +
            'return contents;\n' +
        '}\n' +
    '})'; 
    
fs.writeFile("./build/app.build.js", appFile, "utf8", function(err) {
    if (err) {
        console.error("Couldn't write app.build.js!")
        console.error(err);
        process.exit(1);
    } 
});